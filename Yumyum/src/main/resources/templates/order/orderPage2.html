<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="layout/basic">
<th:block layout:fragment="title">
	<title>결제</title>
</th:block>

<th:block layout:fragment="header">
	<h4 class="display-3 fw-bolder">
		O R D E R <input type="hidden" th:value="${session.loginMember}"
			id="loginMemberInput">
	</h4>
	<p class="lead fw-normal text-white-50 mb-0"></p>
</th:block>


<th:block layout:fragment="content">

	<div class="container ">
		<div class="row">
			<div class="col-sm-6">
				<!-- 지점명 -->
				<h2 th:text="${ branchName }"></h2>
				<hr style="margin: 20px">
				<!-- 주문내역 카드 -->
				<!-- 추가 할 내용으로 사이드바에서 구매 버튼을 클릭했을 때, post method로 데이터를 넘겨와야 하고 이 값을 각 영역에 매핑해야 한다. -->
				<div class="card mb-3" style="max-width: 540px;"
					th:if="${not #lists.isEmpty( cartList )}"
					th:each="cart : ${ cartList }">
					<div class="row g-0">
						<div class="col-md-4">
							<img th:src="${ cart.imgPath }" class="img-fluid rounded-start"
								alt="...">
						</div>
						<div class="col-md-8">
							<div class="card-body">
								<h5 class="card-title">주문 내역</h5>
								<span class="card-text" th:text="|${ cart.name }|"></span> 
								<span class="card-text" th:text="|${ cart.price } 원|"></span><br>
								<small class="text-muted" th:if="${ cart.shotCustom }==1">샷 추가 :  선택안함</small>
								<small class="text-muted" th:if="${ cart.shotCustom }==2">샷 추가 :  연하게</small>
								<small class="text-muted" th:if="${ cart.shotCustom }==3">샷 추가 :  샷 추가(+500)</small>
								<small class="text-muted" th:if="${ cart.shotCustom }==4">샷 추가 :  2샷 추가(+1,000)</small>
								<small class="text-muted" th:if="${ cart.shotCustom }==5">Bakery</small>
								<span class="card-text" th:text="|x ${ cart.qty }|"></span><br>
								<span class="card-text" th:text="|합계 ${cart.totalPrice }원|"></span>
								<!-- <hr Style="margin-top:10px"> -->
							</div>
						</div>
					</div>
				</div>
				<hr style="margin: 20px">


				<!-- 픽업 여부 -->
				<!-- 결제 시 데이터 테이블에 커밋! -->
				<div>
					<h2>픽업 옵션</h2>
					<br style="margin: 10px"> 
					<input name="pickup" type="radio" checked>매장 
					<input name="pickup" type="radio">포장
				</div>
				<hr style="margin: 20px">

				<!-- 픽업 시간 -->
				<!-- 임의의 항목인데, 매장에서만 알 수 있는 데이터임 -->
				<div>
					<h2>픽업 시간</h2>
					<br style="margin: 10px">
					<!-- <div class="btn-group" role="group"> -->
					<div class="d-flex justify-content-around">
						<button type="button"
							class="btn btn-outline-secondary button-class1" value="바로">바로</button>
						<button type="button"
							class="btn btn-outline-secondary button-class2" value="5분후">5분
							후</button>
						<button type="button"
							class="btn btn-outline-secondary button-class3" value="10분후">10분
							후</button>
						<button type="button"
							class="btn btn-outline-secondary button-class4" value="15분후">15분
							후</button>
					</div>
					<!-- </div> -->
				</div>
			</div>

			<!-- 화면 분할 -->
			<div class="col-sm-6">
				<!-- 보유 쿠폰 목록 -->
				<!-- 로그인 한 계정이 보유한 쿠폰을 보여 주기 때문에 큰 수정은 없을 듯 -->
				<div>
					<h2>할인 쿠폰</h2>
					<br style="margin: 10px"> <select>
						<option th:if="${not #lists.isEmpty( couponList )}"
							th:each="coupon, i : ${ couponList }" th:id="'CP'+${i.index+1}"
							th:text="|${coupon.kind}, ${coupon.expirationDate}|"></option>
					</select>
					<button id="btn_select">+</button>
					<div id="selectedCoupon"></div>
				</div>
				<hr style="margin: 20px">

				<!-- 결제 수단 -->
				<!-- value 값을 pay_method 데이터로 넘겨 iamport()에 넣으면 된다. -->
				<h2>결제수단</h2>
				<br style="margin: 10px"> <input type="radio" value="card">신용카드
				<hr style="margin: 20px">

				<!-- 결제 금액 -->
				<div id="calc" class=""></div>

				<br>

				<div class="text-right" style="padding: 10px">
					<!-- 결제의 파라미터로 주문번호, 총액, 결제수단을 넣어주면 될 것 같다. -->
					<button type="button" class="btn btn-outline-primary"
						style="font-size: 1.2em"
						th:onclick="|javascript:iamport(111, ${ totalPrice }, ${ payMethod })|">구매</button>
<!-- 						th:onclick="|javascript:iamport(${ orderNum }, ${ totalPrice }, ${ payMethod })|">구매</button> -->
				</div>
			</div>
		</div>
	</div>

</th:block>

<th:block layout:fragment="script">
	<script type="text/javascript"
		src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script type="text/javascript"
		src="https://cdn.iamport.kr/js/iamport.payment-1.1.8.js"></script>
	<script th:inline="javascript">
		/*<![CDATA[*/

	    const orderList = /*[[${ cartList }]]*/null; 
		
		//총 금액 펑션
		$(function(){
		var totalPrice = /*[[${ totalPrice }]]*/null;
		var totalQty = /*[[${ totalQty }]]*/null;
			  var html = "";
			  html = "<div>총 수량 " + totalQty + "</div>"
			  html += "<div>결제 금액 " + totalPrice + "</div>";
			  $('#calc').append(html);
		})
			  
		
		//셀렉트 박스 text() 가져오기
		$('#btn_select').on("click", function() {
			var coupon = $("select option:selected").text();
			var couponId = $("select option:selected").attr('id');

			var html = "";
			var html = '<div id=\'' + couponId + '\'>' + coupon + '</div>';

			$('select option:selected').attr('disabled', true);

			//타겟의 첫번째 id값과 선택한 coupon의 id값을 비교하여 실행
			if ($('#selectedCoupon').children('div').attr('id') != couponId) {
				$('#selectedCoupon').prepend(html);
			}
			;

			var ele = document.getElementById('selectedCoupon');
			var eleCount = ele.childElementCount; //'#selectedCoupon' 밑의 요소갯수 출력

			console.log(eleCount);

			/* return eleCount; */
		});

		function iamport(orderNum, totalPrice, payMethod) {
			//가맹점 식별코드
			var IMP = window.IMP;
			IMP.init('imp46753753');
			IMP.request_pay({
				pg : 'kcp',
				pay_method : payMethod, //결제 방법 선택
				merchant_uid : 'merchant_' + new Date().getTime(),
				name : "주문번호" + orderNum, //결제창에서 보여질 이름
				amount : totalPrice, //실제 결제되는 가격
				buyer_email : 'iamport@siot.do',
				buyer_name : '구매자이름',
				buyer_tel : '010-1234-5678',
				buyer_addr : '서울 강남구 도곡동',
				buyer_postcode : '123-456',
			}, function(rsp) {
				console.log(rsp);
				if (rsp.success) {
					var msg = '결제가 완료되었습니다.';
					msg += '고유ID : ' + rsp.imp_uid;
					msg += '상점 거래ID : ' + rsp.merchant_uid;
					msg += '결제 금액 : ' + rsp.paid_amount;
					msg += '카드 승인번호 : ' + rsp.apply_num;

					$.ajax({
						method : "POST",
						/* type : "POST", */
						url : "/payment/" + rsp.imp_uid,
						/* url : "/payment", */
						success : function(data) {
							console.log(data)
						}, //success end
						error : function(request, status, error) {
							console.log("code: " + request.status)
							console.log("message: " + request.responseText)
							console.log("error: " + error);
						} //error end
					}).done(function(data) {

						console.log(data);

						// 위의 rsp.paid_amount 와 data.response.amount를 비교한후 로직 실행 (import 서버검증)
						if (rsp.paid_amount == data.response.amount) {
							alert("결제 및 결제검증완료");
						} else {
							alert("결제 실패");
						}
					}); // ajax end
				} else {
					var msg = '결제에 실패하였습니다.';
					msg += '에러내용 : ' + rsp.error_msg;
				}
				alert(msg);
			});
		}; // iamport function end

		//버튼 토글
		$(function() {

			$('.button-class1').click(function() {
				if ($(this).hasClass('btn-outline-secondary'))
					$(this).removeClass('btn-outline-secondary');
				if (!$(this).hasClass('btn-outline-primary'))
					$(this).addClass('btn-outline-primary');
				if ($('.button-class2').hasClass('btn-outline-primary'))
					$('.button-class2').removeClass('btn-outline-primary');
				if (!$('.button-class2').hasClass('btn-outline-secondary'))
					$('.button-class2').addClass('btn-outline-secondary');
				if ($('.button-class3').hasClass('btn-outline-primary'))
					$('.button-class3').removeClass('btn-outline-primary');
				if (!$('.button-class3').hasClass('btn-outline-secondary'))
					$('.button-class3').addClass('btn-outline-secondary');
				if ($('.button-class4').hasClass('btn-outline-primary'))
					$('.button-class4').removeClass('btn-outline-primary');
				if (!$('.button-class4').hasClass('btn-outline-secondary'))
					$('.button-class4').addClass('btn-outline-secondary');
			});

			$('.button-class2').click(function() {
				if ($(this).hasClass('btn-outline-secondary'))
					$(this).removeClass('btn-outline-secondary');
				if (!$(this).hasClass('btn-outline-primary'))
					$(this).addClass('btn-outline-primary');
				if ($('.button-class1').hasClass('btn-outline-primary'))
					$('.button-class1').removeClass('btn-outline-primary');
				if (!$('.button-class1').hasClass('btn-outline-secondary'))
					$('.button-class1').addClass('btn-outline-secondary');
				if ($('.button-class3').hasClass('btn-outline-primary'))
					$('.button-class3').removeClass('btn-outline-primary');
				if (!$('.button-class3').hasClass('btn-outline-secondary'))
					$('.button-class3').addClass('btn-outline-secondary');
				if ($('.button-class4').hasClass('btn-outline-primary'))
					$('.button-class4').removeClass('btn-outline-primary');
				if (!$('.button-class4').hasClass('btn-outline-secondary'))
					$('.button-class4').addClass('btn-outline-secondary');
			});

			$('.button-class3').click(function() {
				if ($(this).hasClass('btn-outline-secondary'))
					$(this).removeClass('btn-outline-secondary');
				if (!$(this).hasClass('btn-outline-primary'))
					$(this).addClass('btn-outline-primary');
				if ($('.button-class1').hasClass('btn-outline-primary'))
					$('.button-class1').removeClass('btn-outline-primary');
				if (!$('.button-class1').hasClass('btn-outline-secondary'))
					$('.button-class1').addClass('btn-outline-secondary');
				if ($('.button-class2').hasClass('btn-outline-primary'))
					$('.button-class2').removeClass('btn-outline-primary');
				if (!$('.button-class2').hasClass('btn-outline-secondary'))
					$('.button-class2').addClass('btn-outline-secondary');
				if ($('.button-class4').hasClass('btn-outline-primary'))
					$('.button-class4').removeClass('btn-outline-primary');
				if (!$('.button-class4').hasClass('btn-outline-secondary'))
					$('.button-class4').addClass('btn-outline-secondary');
			});

			$('.button-class4').click(function() {
				if ($(this).hasClass('btn-outline-secondary'))
					$(this).removeClass('btn-outline-secondary');
				if (!$(this).hasClass('btn-outline-primary'))
					$(this).addClass('btn-outline-primary');
				if ($('.button-class1').hasClass('btn-outline-primary'))
					$('.button-class1').removeClass('btn-outline-primary');
				if (!$('.button-class1').hasClass('btn-outline-secondary'))
					$('.button-class1').addClass('btn-outline-secondary');
				if ($('.button-class2').hasClass('btn-outline-primary'))
					$('.button-class2').removeClass('btn-outline-primary');
				if (!$('.button-class2').hasClass('btn-outline-secondary'))
					$('.button-class2').addClass('btn-outline-secondary');
				if ($('.button-class3').hasClass('btn-outline-primary'))
					$('.button-class3').removeClass('btn-outline-primary');
				if (!$('.button-class3').hasClass('btn-outline-secondary'))
					$('.button-class3').addClass('btn-outline-secondary');
			});

		});

		// 모달1
		const modal1 = document.querySelector(".modal1");
		const closeBtn1 = document.querySelector(".close1");

		closeBtn1.onclick = function() {
			modal1.style.display = "none";
		}
		//모달창 오픈 func
		function explain1() {
			modal1.style.display = "block";
		}
		$(function() {
			$(".modal1").draggable();
		});

		/*[- end of function -]*/

		/*]]>*/
	</script>
</th:block>

</html>